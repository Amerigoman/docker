{% extends 'base.html' %}
{% load waffle_tags %}
{% load i18n %}
{% load static %}
{% load gravatar %}

{% block title %}Issue detail{% endblock %}

{% block breadcrumbs %}
  {{ block.super }}
  <li>
    <a href="{% url 'project:list' %}">Projects</a>
  </li>
  <li>
    <a href="{% url 'project:detail' project.id %}">{{ project.title }}</a>
  </li>
  {% if issue.sprint %}
    <li>
      <a href="{% url 'project:sprint_active' project.id %}"> {{ issue.sprint.title }}</a>
    </li>
  {% else %}
    <li>
      <a href="{% url 'project:backlog' project.id %}">Backlog</a>
    </li>
  {% endif %}
  <li>
    <span>{{ issue.title }}</span>
  </li>
{% endblock %}

{% block content %}
  <div style="display: inline">
    {% flag "edit_issue" %}

      <a href="{% url 'project:issue_edit' project.id issue.id %}"
         class="btn btn-default pull-right">Edit this issue</a>
    {% endflag %}
    {% flag "create_issue" %}
      <a href="{% url 'project:issue_create' project.id %}?root={{ issue.id }}"
         class="btn btn-success pull-right" style="margin-right: 3px;">Create sub issue</a>
    {% endflag %}
  </div>
  {% include 'project/project_navbar.html' with sprint_detail=True %}
  <div class="col-sm-8">
    <div class="profile-user-info profile-user-info-striped">
      <div class="profile-info-row">
        <div class="profile-info-name"> Title</div>
        <div class="profile-info-value">
          <span>{{ issue.title }}</span>
        </div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-name"> Status</div>
        <div class="profile-info-value">
          <span>{{ issue.status }}</span>
        </div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-name"> Root</div>
        <div class="profile-info-value">
          <span>{{ issue.root }}</span>
        </div>
      </div>
    <div class="profile-info-row">
        <div class="profile-info-name"> Type</div>
        <div class="profile-info-value">
          <span>{{ issue.type }}</span>
        </div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-name">Estimation</div>
        <div class="profile-info-value">
          <span>{{ issue.estimation }}</span>
        </div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-name">Author</div>
        <div class="profile-info-value">
          <span>{{ issue.author }}</span>
        </div>
      </div>
      {% if issue.employee %}
        <div class="profile-info-row">
          <div class="profile-info-name">Employee</div>
          <div class="profile-info-value">
            <span>{{ issue.employee }}</span>
          </div>
        </div>
      {% endif %}
      <div class="profile-info-row">
        <div class="profile-info-name">Description</div>
        <div class="profile-info-value">
          <span>{{ issue.description }}</span>
        </div>
      </div>
    </div>
    <form method="post" action='{% url "project:issue_detail" project.id issue.id %}'>
      <div class="form-actions">
        <div class="input-group">
          {{ form.text }}
          <span class="input-group-btn">{% csrf_token %}
            <button class="btn btn-sm btn-info no-radius" type="submit">
              <i class="ace-icon fa fa-share"></i>
              Comment
            </button>
          </span>
        </div>
      </div>
    </form>
    <div class="tab-pane">
      <div class="comments">
        {% for comment in issue.issuecomment_set.all %}
          <div class="itemdiv commentdiv">
            <div class="user">
              <img {% if comment.author.photo %}
                src="{{ comment.author.get_cropped_photo.url }}"
              {% else %}
                src="{{ comment.author.email|gravatar_url:40 }}"
              {% endif %}/>
            </div>
            <div class="body">
              <div class="name">
                <a href="{% url 'employee:detail' comment.author.id %}">
                  {{ comment.author.username }}
                </a>
              </div>
              <div class="time">
                <span>{{ comment.get_pretty_date_created }}</span>
              </div>
              <div class="text">
                {{ comment.text }}
              </div>
            </div>
            {% if request.user == comment.author %}
              <div class="tools">
                <div class="action-buttons bigger-125">
                  <a href=".">
                    <i class="ace-icon fa fa-pencil blue"></i>
                  </a>

                  <a href=".">
                    <i class="ace-icon fa fa-trash-o red"></i>
                  </a>
                </div>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="col-sm-4">
  {% if root_issue %}
    <div class="row">
    <div class="col-sm-12">
    <div class="widget-box widget-color-blue2">
      <div class="widget-header">
        <h4 class="widget-title bigger lighter">Parent issue</h4>
      </div>
      <div class="widget-body">
        <div class="widget-main no-padding">
          <table class="table table-striped table-bordered table-hover">
            <thead class="thin-border-bottom">
            <tr>
              <th>#</th>
              <th>Title</th>
              <th>Status</th>
              <th>Estimation</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td>1</td>
              <td>
                <a href="{% url 'project:issue_detail' project.id root_issue.id %}">
                  {{ root_issue.title }}</a>
              </td>
              <td>{{ root_issue.status }}</td>
              <td>{{ root_issue.estimation }}</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}
{% if child_issues %}
  <div class="row">
    <div class="col-sm-12">
      <div class="widget-box widget-color-blue2">
        <div class="widget-header">
          <h4 class="widget-title bigger lighter">Child Issues</h4>
        </div>
        <div class="widget-body">
          <div class="widget-main no-padding">
            <table class="table table-striped table-bordered table-hover">
              <thead class="thin-border-bottom">
              <tr>
                <th>#</th>
                <th>Title</th>
                <th>Status</th>
                <th>Estimation</th>
              </tr>
              </thead>
              <tbody>
              {% for child in child_issues %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>
                    <a href="{% url 'project:issue_detail' project.id child.id %}">{{ child.title }} </a>
                  </td>
                  <td>{{ child.status }}</td>
                  <td>{{ child.estimation }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endif %}
</div>
{% endblock %}

